## 1. Redis哨兵

> ***面试官：Redis哨兵知道吧？***

知道的面试官，Sentinel哨兵本质是一个运行在特殊模式下的Redis服务器。

### 1.1 哨兵作用

> ***面试官：嗯然后呢？***

Sentinel哨兵可以是一个或多个实例组成的哨兵系统。

它的主要作用是通过检测**Redis主从服务器**的下线状态，**选举出新Redis主服务器**，也就是**故障转移**，来保证Redis的高可用性。

### 1.2 检测主从下线状态

> ***面试官：你说说是怎么检测Redis主从服务器的下线状态的？***

好的。检测下线状态有两种方式。

1. **检测主观下线状态**的话，默认情况Sentinel会每隔1s向Redis主、从服务器发送PING命令，通过返回的信息来判断下线状态
2. **检测客观下线状态**的话，是Sentinl在主观判断下线后，会向其他Sentinel进行询问**是否同意**该节点已下线，当标记下线的**数量足够多**就会判断客观下线

![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/a62d0c09b26443369ee0625fece54ccd.png#pic_center)

### 1.3 哨兵配置

> ***面试官：有没有A哨兵判断Redis实例下线，但B哨兵判断Redis实例仍然存活的情况呢？***

有的面试官，主要还是看各个**哨兵的配置**。

像检测主观下线状态的话，要看Sentinel判断Redis实例进入主观下线**所需的响应时间长度**。A哨兵的配置是10000毫秒、B哨兵是5000毫秒，但Redis实例要在20000毫秒才响应，像这种情况就会发生。

而检测客观下线状态的话，要看配置需要其他Sentinel同意主服务器**已下线的数量**。

### 1.4 选举领头哨兵

> ***面试官：领头哨兵怎么选举出来的？***

是这样的，Sentinel设置局部领头Sentinel的规则是**先到先得**。

最先向**目标Sentinel**发送设置要求的源Sentinel将成为目标Sentinel的**局部领头Sentinel**，而之后接收到的所有设置要求都会被目标Sentinel拒绝。

如果有某个Sentinel被**半数以上**的Sentinel设置成了局部领头Sentinel，那么这个Sentinel就会成为领头Sentinel。

### 1.5 领头哨兵的作用

> ***面试官：选举出来之后呢，它有什么作用吗？***

**领头Sentinel**起到执行故障转移的作用，也就是**选举出新的Redis主服务器**，而且只有当Redis主服务器被判断**客观下线**后才会选举出领头Sentinel。

## 2. 选举Redis主服务器

> ***面试官：知道怎么选举新的Redis主服务器吗？***

我整理下。

1. 领头Sentinel会将已下线Redis主服务器的所有Redis从服务器保存到一个列表里面
2. 通过**删除策略**，删除所有处于下线或者断线状态的、删除最近五秒内没有回复过领头Sentinel命令的、删除与已下线主服务器连接断开超过10毫秒的
3. 如果有多个相同优先级的从服务器，将按照**复制偏移量**进行排序选出偏移量最大的，复制偏移量最大也就是数据同步最新的
4. 最后选出的Redis实例也就成为新的Redis主服务器
