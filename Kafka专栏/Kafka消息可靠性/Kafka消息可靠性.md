## 1. Kafka高水位

> ***面试官：知道Kafka高水位吗？***

当前高水位就是复制偏移量，记录了当前**已提交消息的最大偏移量**。

是这样的，Kafka的消息只有在**所有分区副本**都同步该消息后，才算是**已提交**的消息。

分区副本会根据**首领分区副本**提供的高水位，来避免**未提交**的消息被消费。
![在这里插入图片描述](https://img-blog.csdnimg.cn/direct/43bfc723d47b46b394fc0f6fedcefeab.png#pic_center)

## 2. Kafka消息可靠性

> ***面试官：你说说Kafka是怎么保证消息可靠性的？***

好的。

在Broker方面，主要使用了**分区多副本架构**，来保证消息不丢失。

Kafka集群的每一个分区的**首领副本**，都会有n（**复制系数**）个broker机器去复制后，生成**跟随者副本**。

同时如果首领副本的机器挂了，跟随者副本会选举成为**新的首领副本**。

分区有多个备份是消息保存的一个可靠性保障。

### 2.1 生产者消费者可靠性

> ***面试官：还有吗，比如生产者消费者呢？***

还有在生产者、消费者方面的可靠性。

一、在生产者方面

1. 提供了**ack = all**这种**发送确认机制**。也就是只有在消息成功**写入所有副本**后，才算该消息已提交，保证了消息的多备份。
2. ack = all失败的话，生产者可以继续**重试**发送消息。

二、在消费者方面

1. 消费者消费时，会根据偏移量进行消费，保证了**消息的顺序性**。
2. 消费后会同步提交、异步**提交偏移量**，保证了消息不被**重复消费**。

### 2.2 消费堆积

> ***面试官：那要是Kafka消费堆积了怎么办？***

这样的话，要从Broker和消费者两方面来看。

一、Broker的话
1. 每个topic是分为多个分区给不同Broker处理，要**合理分配分区数量**来提高Broker的消息处理能力。比如3个Broker2个分区，可以改为3个Broker3个分区
2. 也可以**横向扩展**Broker集群

二、消费者的话
1. 可以增加消费者服务数量
2. 提交偏移量时，可以把同步提交改为**异步提交**，来减少同步等待Broker的时间

## 3. Kafka控制器

> ***面试官：emmmm，你知道Kafka控制器吧？***

知道的。控制器其实也是一个broker，不过它还负责选举**分区首领**。

也就是在首领副本所在的分区失效后，通过控制器来在分区副本里选举出新的**首领副本**。
